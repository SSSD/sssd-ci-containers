- name: Enable docs installation by default
  block:
  - name: Check dnf.conf exists
    stat:
      path: /etc/dnf/dnf.conf
    register: dnf_stat_result

  - name: Patch dnf.conf
    replace:
      path: /etc/dnf/dnf.conf
      regexp: 'nodocs'
      replace: ''
    when: dnf_stat_result.stat.exists

- name: Install packages for ground base image
  block:
  - name: Install dnf plugins
    dnf:
      state: present
      name:
      - dnf-plugins-core

  - name: Install @sssd/ci-deps repositories
    shell: |
      dnf copr enable -y @sssd/ci-deps

  - name: Install systemd and minimal set of packages
    dnf:
      state: present
      name:
      - authselect
      - bind-utils
      - expect
      - firewalld
      - iproute
      - iproute-tc
      - net-tools
      - openldap-clients
      - openssh-clients
      - openssh-server
      - passwd
      - policycoreutils
      - policycoreutils-python-utils
      - python3-pip
      - sudo
      - systemd
  when: "'base_ground' in group_names"

- name: Install extended set of packages
  block:
  - name: Install additional repositories
    shell: |
      dnf config-manager --add-repo {{ item }}
    with_items:
    - https://cli.github.com/packages/rpm/gh-cli.repo
  - name: Install additional packages
    dnf:
      state: present
      name:
      - bash-completion
      - bind-utils
      - dbus-tools
      - e2fsprogs
      - expect
      - findutils
      - firewalld
      - gdb
      - gdb-gdbserver
      - iputils
      - ldb-tools
      - man
      - net-tools
      - passwd
      - policycoreutils
      - policycoreutils-python-utils
      - python3-pip
      - rsync
      - tcpdump
      - wget
      - which
      - wireshark-cli
      - gh
      - git
      - mc
      - tig
      - tmate
      - tmux
      - vim
  when:
  - "'base_ground' in group_names"
  - extended_packageset

- name: Install packages for client base image
  block:
  - name: Install ipa client
    dnf:
      state: present
      name: '{{ ipa.client }}'

  - name: Install SSSD
    dnf:
      state: present
      name:
      - sssd
      - sssd-*

  - name: Install debug information for selected packages
    command: dnf debuginfo-install  -y  {{ item }}
    with_items:
      - dbus
      - glibc
      - libcmocka
      - libdhash
      - libini_config
      - libldb
      - libtalloc
      - libtevent
    ignore_errors: yes
    when: debuginfo

  - name: Install test dependencies on client
    dnf:
      state: present
      name:
      - autofs
      - augeas
      - krb5-workstation
      - ldb-tools
      - net-tools
      - nfs-utils
      - nss-pam-ldapd
      - realmd
      - tcpdump
      - wireshark-cli
  when: "'base_client' in group_names"

- name: Install packages for LDAP base image
  block:
  - name: Install 389ds
    dnf:
      state: present
      name:
      - acl
      - 389-ds-base
  when: "'base_ldap' in group_names"

- name: Install packages for IPA base image
  block:
  - name: Install IPA
    dnf:
      state: present
      name: '{{ ipa.server }}'
  when: "'base_ipa' in group_names"

- name: Install packages for Samba base image
  block:
  - name: Install Samba DC
    dnf:
      state: present
      name:
      - samba-dc
      - samba-winbind-clients
  when: "'base_samba' in group_names"

- name: Install packages for NFS base image
  block:
  - name: Install NFS
    dnf:
      state: present
      name:
      - nfs-utils
  when: "'base_nfs' in group_names"

- name: Install packages for KDC base image
  block:
  - name: Install KDC
    dnf:
      state: present
      name:
      - krb5-libs
      - krb5-server
      - krb5-workstation
  when: "'base_kdc' in group_names"

- name: Install packages that are shared with IPA and client base images
  block:
  - name: Install packages required for passkey testing
    dnf:
      state: present
      name:
      - ci-sssd-random
      - umockdev
    when: passkey_support
  when: "'base_client' in group_names or 'base_ipa' in group_names"

- name: Install packages for Keycloak base image
  block:
  - name: Install Keycloak dependencies
    dnf:
      state: present
      allowerasing: true
      name:
      - java-17-openjdk-headless
      - openssl
      - unzip
      - curl
      - jq
  when: "'base_keycloak' in group_names"

- name: Install additional packages for client development image
  block:
  - name: Install SSSD build dependencies
    command: dnf build-dep -y sssd

  - name: Install packages required for integration tests
    dnf:
      state: present
      name:
      - clang-analyzer
      - curl-devel
      - dbus-daemon
      - fakeroot
      - http-parser-devel
      - krb5-server
      - krb5-workstation
      - lcov
      - libcmocka-devel
      - libfaketime
      - mock
      - nss_wrapper
      - openldap-clients
      - openldap-servers
      - pam_wrapper
      - python3-ldap
      - python3-ldb
      - python3-psutil
      - python3-pycodestyle
      - python3-pytest
      - python3-requests
      - rpm-build
      - uid_wrapper
      - valgrind

  - name: Install additional python packages
    pip:
      name:
      - flaky
  when: "'client_devel' in group_names or 'ipa_devel' in group_names"
